<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Photo Alert</title>
<style>
  :root{--ok:#16a34a;--err:#dc2626;--ink:#111827;--muted:#6b7280;--line:#e5e7eb}
  *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;margin:0;padding:24px;color:var(--ink)}
  .card{max-width:680px;margin:0 auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:24px;box-shadow:0 2px 16px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
  .muted{color:var(--muted)} .big{font-size:20px;font-weight:700;margin:8px 0 4px}
  .ok{color:var(--ok)} .err{color:var(--err)} .hint{font-size:13px;margin-top:8px}
  .btns{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
  a.btn,button.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 14px;text-decoration:none;color:var(--ink);font-weight:600}
  a.btn:hover,button.btn:hover{background:#f9fafb}
</style>

<div class="card">
  <div class="row">
    <div class="badge" id="build">BUILD v1.2</div>
    <div class="badge" id="zone">ET</div>
    <div class="badge" id="serialBadge"></div>
  </div>

  <div class="big" id="title">Waiting to send…</div>
  <div class="muted" id="meta"></div>
  <div class="hint" id="status">Will send when page is visible.</div>

  <div class="btns" id="actions" style="display:none">
    <a class="btn" id="viewLink" target="_blank">Open feed</a>
    <a class="btn" id="smsLink">SMS backup</a>
    <button class="btn" id="again">Send again</button>
  </div>
</div>

<script>
(() => {
  // --- CONFIG ---
  const TOPIC  = 'fommco-mach-complete-as9345714ljvtf'; // ntfy topic (no domain)
  const SMS_TO = '+19374168945';                        // backup SMS
  const DEDUPE_TTL_MS = 8000;                           // 8s window to suppress dup opens
  // --------------

  const p   = new URLSearchParams(location.search);
  const mid = (p.get('mid') || 'Unknown').trim();
  const loc = (p.get('loc') || 'Unknown').trim();
  const allowMulti = p.get('allowMulti') === '1';

  const nowET = new Date(new Date().toLocaleString('en-US',{ timeZone:'America/New_York' }));
  const sn = (p.get('id') || genSerial(nowET)).trim();
  const stamp = nowET.toLocaleString('en-US',{ timeZone:'America/New_York' });
  const msg   = `Machine ${mid} READY - ${loc} - ${stamp} - ${sn}`;
  const ntfyUrl = `https://ntfy.sh/${encodeURIComponent(TOPIC)}`;

  // UI
  document.getElementById('meta').textContent = `MID: ${mid} • LOC: ${loc}`;
  document.getElementById('serialBadge').textContent = sn;
  document.getElementById('viewLink').href = `https://ntfy.sh/${encodeURIComponent(TOPIC)}/json?poll=1`;
  document.getElementById('smsLink').href  = `sms:${encodeURIComponent(SMS_TO)}?&body=${encodeURIComponent(msg)}`;
  document.getElementById('again').onclick = () => { sent=false; doSend(); };

  // --- robust dedupe: cross-tab + short TTL ---
  const key = `dedupe:${mid}|${loc}|${sn}`;
  const last = +localStorage.getItem(key) || 0;
  const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('photo-alert') : null;

  let sent = false;
  if (!allowMulti && (Date.now()-last) < DEDUPE_TTL_MS) {
    markDone(true, 208, 'Already sent (recent duplicate suppressed)');
    return;
  }
  if (bc) bc.onmessage = (ev) => {
    if (!allowMulti && ev.data === key && !sent) {
      markDone(true, 208, 'Duplicate window (suppressed by broadcast)');
    }
  };

  // Only send when page is *visible* (previews/prefetch are hidden)
  if (document.visibilityState === 'visible') doSend();
  else {
    document.getElementById('status').textContent = 'Waiting for visibility…';
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !sent) doSend();
    }, { once: true });
  }

  async function doSend(){
    if (sent) return;
    sent = true;
    setStatus('Posting to ntfy…');

    try {
      const r = await fetch(ntfyUrl, { method:'POST', headers:{'Content-Type':'text/plain'}, body: msg });
      if (r.ok) return markDone(true, r.status);
    } catch (_) { /* fall through */ }

    try {
      // Fallback: form submit
      const form = document.createElement('form');
      form.method='POST'; form.action=ntfyUrl; form.enctype='text/plain'; form.target='sink';
      const input = document.createElement('input'); input.name='m'; input.value=msg;
      form.appendChild(input);
      const sink = document.createElement('iframe'); sink.name='sink'; sink.style.display='none';
      document.body.appendChild(sink); document.body.appendChild(form); form.submit();
      markDone(true, 200, 'Form fallback');
    } catch (e) {
      markDone(false, 0, e?.message || 'Unknown error');
    }
  }

  function markDone(ok, code, extra){
    localStorage.setItem(key, Date.now());
    if (bc) { try { bc.postMessage(key); } catch(_){} }
    document.getElementById('actions').style.display = 'flex';
    document.getElementById('title').innerHTML = ok ? '✅ Photo Alert Sent' : '❌ Send Failed';
    setStatus(`ntfy response: <code>${code}</code>${extra?' • '+escapeHtml(extra):''}`, ok);
  }

  function genSerial(d){
    const pad=n=>String(n).padStart(2,'0');
    const y=d.getFullYear(), m=pad(d.getMonth()+1), day=pad(d.getDate());
    const H=pad(d.getHours()), M=pad(d.getMinutes()), S=pad(d.getSeconds());
    const r=String(Math.floor(Math.random()*1000)).padStart(3,'0');
    return `SN-${y}${m}${day}-${H}${M}${S}-${r}`;
  }

  function setStatus(text, good){
    const el=document.getElementById('status');
    el.innerHTML=text; el.className='hint '+(good===true?'ok':good===false?'err':'');
  }
  function escapeHtml(s){ return String(s).replace(/[<>&"]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c])); }
})();
</script>
